<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Di·ªÖn ƒë√†n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <div class="d-flex align-items-center">
                <a href="/dashboard" class="btn btn-outline-secondary btn-sm me-2" title="üè† Home">üè† Home </a>
                <a class="navbar-brand fw-bold" href="/">üéì Forum</a>
            </div>
                <div class="d-flex">
                    {% if session.get('user_id') %}
                    {% if session.get('role') == 'student' %}
                    <a href="/post/new" class="btn btn-success me-2">+ B√†i vi·∫øt m·ªõi</a>
                    {% endif %}

                    {% if session.get('role') == 'expert' %}
                    <form action="/chat/toggle-opt-in" method="POST" class="d-flex me-2">
                        {% if session.get('chat_opt_in') == 1 %}
                        <button type="submit" class="btn btn-success">
                            üü¢ ƒêang Online (S·∫µn s√†ng chat)
                        </button>
                        {% else %}
                        <button type="submit" class="btn btn-outline-secondary">
                            ‚ö™ ƒêang Offline
                        </button>
                        {% endif %}
                    </form>
                    {% endif %}
                    <a href="/logout" class="btn btn-outline-danger">ƒêƒÉng xu·∫•t</a>
                    {% else %}
                    <a href="/login" class="btn btn-outline-primary me-2">title="ƒêƒÉng nh·∫≠p">ƒêƒÉng nh·∫≠p</a>
                    <a href="/register" class="btn btn-primary">title="ƒêƒÉng k√Ω">ƒêƒÉng k√Ω</a>
                    {% endif %}
                </div>
            </div>
    </nav>

    <div class="container mt-4">

            {% if session.get('role') == 'student' %}

            {% if session.get('status_tag') %}
            <div class="card shadow-sm mb-4 bg-light border-success">
                <div class="card-body text-center">
                    <h5 class="card-title text-success fw-bold">B·∫°n l√† Ng∆∞·ªùi H·ªó Tr·ª£ ü§ù</h5>
                    <p class="card-text text-muted">C·∫£m ∆°n b·∫°n ƒë√£ s·∫µn s√†ng chia s·∫ª. H√£y b·∫≠t "Online" khi b·∫°n r·∫£nh ƒë·ªÉ gi√∫p ƒë·ª° ng∆∞·ªùi kh√°c nh√©.</p>
                    <form action="/chat/toggle-opt-in" method="POST" class="d-flex justify-content-center">
                        {% if session.get('chat_opt_in') == 1 %}
                        <button type="submit" class="btn btn-success btn-lg">
                            üü¢ ƒêang Online (S·∫µn s√†ng chat)
                        </button>
                        {% else %}
                        <button type="submit" class="btn btn-outline-secondary btn-lg">
                            ‚ö™ ƒêang Offline
                        </button>
                        {% endif %}
                    </form>
                </div>
            </div>

            {% else %}
            <div class="card shadow-sm mb-4 bg-light border-primary">
                <div class="card-body text-center">
                    <h5 class="card-title text-primary fw-bold">K·∫øt n·ªëi 1-1 ·∫®n danh</h5>
                    <p class="card-text text-muted">B·∫°n c·∫ßn ng∆∞·ªùi l·∫Øng nghe? H√£y tr√≤ chuy·ªán v·ªõi m·ªôt ng∆∞·ªùi ƒë√£ v∆∞·ª£t qua ho·∫∑c m·ªôt chuy√™n gia.</p>

                    <div class="d-flex justify-content-center align-items-center">
                        <select id="illness-select" name="illness_type" class="form-select w-auto me-2" required>
                            <option value="" disabled selected>Ch·ªçn ch·ªß ƒë·ªÅ b·∫°n c·∫ßn...</option>
                            <option value="depression">Tr·∫ßm c·∫£m</option>
                            <option value="anxiety">Lo √¢u</option>
                            <option value="stress">CƒÉng th·∫≥ng / Stress</option>
                            <option value="relationships">M·ªëi quan h·ªá</option>
                            <option value="other">Ch·ªß ƒë·ªÅ kh√°c</option>
                        </select>
                        <button type="button" id="find-chat-btn" class="btn btn-primary ">‚ö° T√¨m ng∆∞·ªùi tr√≤ chuy·ªán</button>
                    </div>

                    <div class="d-flex justify-content-center align-items-center mt-2">
                        <button type="button" id="stop-chat-btn" class="btn btn-danger " style="display: none;">
                            ‚ùå D·ª´ng t√¨m ki·∫øm
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endif %}

            <h3 class="text-center mb-4">üì¢ Di·ªÖn ƒë√†n H·ªèi & ƒê√°p</h3>

            <!-- Thanh t√¨m ki·∫øm -->
            <form action="{{ url_for('forum.search_forum') }}" method="get" class="mb-4 text-center">
                <input type="text" name="q" placeholder="T√¨m ki·∫øm..." value="{{ query or '' }}" class="form-control d-inline-block w-50">
                <button type="submit" class="btn btn-primary ms-2">T√¨m ki·∫øm</button>
            </form>

            {% if posts %}
            <div class="row justify-content-center">
                <div class="col-md-8">
                    {% for post in posts %}
                    <div class="card mb-4 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">{{ post['title'] }}</h5>
                            <h6 class="card-subtitle mb-2 text-muted">
                                ƒêƒÉng b·ªüi <b>{{ post['username'] }}</b>
                                {% if post['tag'] == 'answered' %}
                                <span class="badge bg-success ms-2">ƒê√£ tr·∫£ l·ªùi</span>
                                {% else %}
                                <span class="badge bg-warning text-dark ms-2">Ch∆∞a tr·∫£ l·ªùi</span>
                                {% endif %}
                            </h6>
                            <p class="card-text mt-3">
                                {{ post['content'] }}
                            </p>

                            {% if session.get('role') == 'expert' %}
                            <a href="/post/{{ post['id'] }}/reply" class="btn btn-sm btn-outline-primary">Tr·∫£ l·ªùi</a>
                            {% endif %}

                            {% if post.get('answers') %}
                            <div class="mt-4">
                                <h6 class="fw-bold text-success">üí¨ Tr·∫£ l·ªùi:</h6>
                                <ul class="list-group list-group-flush">
                                    {% for ans in post['answers'] %}
                                    <li class="list-group-item">
                                        <i>{{ ans['content'] }}</i>
                                        <span class="text-muted small">‚Äî {{ ans['expert_username'] }}</span>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <p class="text-center text-muted">Hi·ªán ch∆∞a c√≥ b√†i vi·∫øt n√†o.</p>
            {% endif %}

    </div> {% if session.get('user_id') %}
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script type="text/javascript">
        const globalSocket = io();
        const USER_ROLE = "{{ session.get('role', 'guest') }}";

        // 3. L·∫ÆNG NGHE L·ªÜNH "√âP" V√ÄO PH√íNG (CHO EXPERT)
        globalSocket.on('force_join_room', (data) => {
            console.log('NH·∫¨N ƒê∆Ø·ª¢C L·ªÜNH V√ÄO PH√íNG!', data);
            window.location.href = data.room_url;
        });

        // 4. L·∫ÆNG NGHE C·∫¢NH B√ÅO AI (CHO EXPERT)
        if (USER_ROLE === 'expert') {
            globalSocket.on('new_alert', (data) => {
                console.log('C·∫¢NH B√ÅO AI!!!', data);
                alert(`C·∫¢NH B√ÅO AI KH·∫®N C·∫§P:\n\n${data.message}\n\n(T·ª´ Session ID: ${data.session_id})`);
            });
        }

        // 5. B·∫ÆT S·ª∞ KI·ªÜN B·∫§M N√öT "T√åM NG∆Ø·ªúI TR√í CHUY·ªÜN" (CHO STUDENT)
        // L∆∞u √Ω: C√°c bi·∫øn n√†y c√≥ th·ªÉ l√† null n·∫øu ng∆∞·ªùi d√πng l√† "Helper"
        const findChatBtn = document.getElementById('find-chat-btn');
        const illnessSelect = document.getElementById('illness-select');
        const stopChatBtn = document.getElementById('stop-chat-btn');
        let isSearching = false;

        // --- H√ÄM HELPER ƒê·ªÇ RESET GIAO DI·ªÜN ---
        function resetSearchUI() {
            isSearching = false;
            if (illnessSelect) illnessSelect.disabled = false;
            if (stopChatBtn) stopChatBtn.style.display = 'none'; // ·∫®n n√∫t "D·ª´ng"
            if (findChatBtn) {
                findChatBtn.disabled = false; // B·∫≠t l·∫°i n√∫t "T√¨m"
                findChatBtn.innerHTML = '‚ö° T√¨m ng∆∞·ªùi tr√≤ chuy·ªán'; // ƒê·∫∑t l·∫°i text
            }
        }

        if (findChatBtn) {
            findChatBtn.addEventListener('click', () => {
                const illnessType = illnessSelect.value;
                if (!illnessType) {
                    alert('Vui l√≤ng ch·ªçn m·ªôt ch·ªß ƒë·ªÅ b·∫°n c·∫ßn gi√∫p ƒë·ª°!');
                    return;
                }

                isSearching = true;
                illnessSelect.disabled = true;
                findChatBtn.disabled = true; // V√¥ hi·ªáu h√≥a n√∫t "T√¨m"
                findChatBtn.innerHTML = 'ƒêang t√¨m ki·∫øm...'; // ƒê·ªïi text (kh√¥ng spinner)
                stopChatBtn.style.display = 'block'; // Hi·ªán n√∫t "D·ª´ng"

                console.log(`ƒêang g·ª≠i y√™u c·∫ßu t√¨m chat, ch·ªß ƒë·ªÅ: ${illnessType}`);
                globalSocket.emit('request_match', { illness: illnessType });
            });
        }

        // 7. B·∫ÆT S·ª∞ KI·ªÜN B·∫§M N√öT "D·ª™NG T√åM KI·∫æM"
        if (stopChatBtn) {
            stopChatBtn.addEventListener('click', () => {
                console.log('Ng∆∞·ªùi d√πng ƒë√£ h·ªßy t√¨m ki·∫øm.');
                globalSocket.emit('cancel_match'); // G·ª≠i t√≠n hi·ªáu H·ª¶Y
                resetSearchUI(); // G·ªçi h√†m reset
            });
        }
        // 8. L·∫ÆNG NGHE T√çN HI·ªÜU "ƒêANG CH·ªú" (K·ªäCH B·∫¢N P3)
        globalSocket.on('match_waiting', (data) => {
            if (!isSearching) return; // N·∫øu user ƒë√£ l·ª° h·ªßy, th√¨ b·ªè qua

            console.log('Server b√°o: ƒêang ch·ªù (ch·ªâ c√≥ P3).', data.message);
            // Quan tr·ªçng: Ch√∫ng ta KH√îNG L√ÄM G√å C·∫¢.
            // UI s·∫Ω ti·∫øp t·ª•c hi·ªÉn th·ªã "ƒêang t√¨m ki·∫øm..." (findChatBtn.style.display = 'none')
            // v√† n√∫t "D·ª´ng t√¨m ki·∫øm" (stopChatBtn.style.display = 'block')
            // ƒê√¢y ch√≠nh l√† tr·∫°ng th√°i "quay v√≤ng v√≤ng" m√† b·∫°n mu·ªën.
        });

        // 6. L·∫ÆNG NGHE K·∫æT QU·∫¢ T√åM KI·∫æM (CHO STUDENT)
        globalSocket.on('match_failed', (data) => {
            if (!isSearching) return;
            console.log('Match th·∫•t b·∫°i!', data);
            alert("R·∫•t ti·∫øc, hi·ªán t·∫°i kh√¥ng c√≥ ai r·∫£nh. Vui l√≤ng th·ª≠ l·∫°i sau.");
            resetSearchUI(); // G·ªçi h√†m reset
        });

        globalSocket.on('match_found', (data) => {
            if (!isSearching) return;
            isSearching = false;

            console.log('Match th√†nh c√¥ng!', data);
            window.location.href = data.room_url;
        });
    </script>
    {% endif %}

</body>
</html>