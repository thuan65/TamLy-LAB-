<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Di·ªÖn ƒë√†n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">üéì Forum</a>
            <div class="d-flex">
                {% if session.get('user_id') %}
                {% if session.get('role') == 'student' %}
                <a href="/post/new" class="btn btn-success me-2">+ B√†i vi·∫øt m·ªõi</a>
                {% endif %}

                {% if session.get('role') == 'expert' or session.get('status_tag') %}

                <form action="/chat/toggle-opt-in" method="POST" class="d-flex me-2">

                    {% if session.get('chat_opt_in') == 1 %}
                    <button type="submit" class="btn btn-success">
                        üü¢ ƒêang Online (S·∫µn s√†ng chat)
                    </button>
                    {% else %}
                    <button type="submit" class="btn btn-outline-secondary">
                        ‚ö™ ƒêang Offline
                    </button>
                    {% endif %}

                </form>
                {% endif %}
                <a href="/logout" class="btn btn-outline-danger">ƒêƒÉng xu·∫•t</a>
                {% else %}
                <a href="/login" class="btn btn-outline-primary me-2">ƒêƒÉng nh·∫≠p</a>
                <a href="/register" class="btn btn-primary">ƒêƒÉng k√Ω</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <div class="container mt-4">

        {% if session.get('role') == 'student' %}
        <div class="card shadow-sm mb-4 bg-light border-primary">
            <div class="card-body text-center">
                <h5 class="card-title text-primary fw-bold">K·∫øt n·ªëi 1-1 ·∫®n danh</h5>
                <p class="card-text text-muted">B·∫°n c·∫ßn ng∆∞·ªùi l·∫Øng nghe? H√£y tr√≤ chuy·ªán v·ªõi m·ªôt ng∆∞·ªùi ƒë√£ v∆∞·ª£t qua ho·∫∑c m·ªôt chuy√™n gia.</p>

                <div class="d-flex justify-content-center align-items-center">
                    <select id="illness-select" name="illness_type" class="form-select w-auto me-2" required>
                        <option value="" disabled selected>Ch·ªçn ch·ªß ƒë·ªÅ b·∫°n c·∫ßn...</option>
                        <option value="depression">Tr·∫ßm c·∫£m</option>
                        <option value="anxiety">Lo √¢u</option>
                        <option value="stress">CƒÉng th·∫≥ng / Stress</option>
                        <option value="relationships">M·ªëi quan h·ªá</option>
                        <option value="other">Ch·ªß ƒë·ªÅ kh√°c</option>
                    </select>

                    <button type="button" id="find-chat-btn" class="btn btn-primary btn-lg">‚ö° T√¨m ng∆∞·ªùi tr√≤ chuy·ªán</button>
                </div>
            </div>
        </div>
        {% endif %}
        <h3 class="text-center mb-4">üì¢ Di·ªÖn ƒë√†n H·ªèi & ƒê√°p</h3>

        {% if posts %}
        <div class="row justify-content-center">
            <div class="col-md-8">
                {% for post in posts %}
                <div class="card mb-4 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">{{ post['title'] }}</h5>
                        <h6 class="card-subtitle mb-2 text-muted">
                            ƒêƒÉng b·ªüi <b>{{ post['username'] }}</b>
                            {% if post['tag'] == 'answered' %}
                            <span class="badge bg-success ms-2">ƒê√£ tr·∫£ l·ªùi</span>
                            {% else %}
                            <span class="badge bg-warning text-dark ms-2">Ch∆∞a tr·∫£ l·ªùi</span>
                            {% endif %}
                        </h6>
                        <p class="card-text mt-3">
                            {{ post['content'] }}
                        </p>

                        {% if session.get('role') == 'expert' %}
                        <a href="/post/{{ post['id'] }}/reply" class="btn btn-sm btn-outline-primary">Tr·∫£ l·ªùi</a>
                        {% endif %}

                        {% if post.get('answers') %}
                        <div class="mt-4">
                            <h6 class="fw-bold text-success">üí¨ Tr·∫£ l·ªùi:</h6>
                            <ul class="list-group list-group-flush">
                                {% for ans in post['answers'] %}
                                <li class="list-group-item">
                                    <i>{{ ans['content'] }}</i>
                                    <span class="text-muted small">‚Äî {{ ans['expert_username'] }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <p class="text-center text-muted">Hi·ªán ch∆∞a c√≥ b√†i vi·∫øt n√†o.</p>
        {% endif %}
    </div>

    {% if session.get('user_id') %}
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

    <script type="text/javascript">
        const globalSocket = io();
        const USER_ROLE = "{{ session.get('role', 'guest') }}";

        // 3. L·∫ÆNG NGHE L·ªÜNH "√âP" V√ÄO PH√íNG (CHO EXPERT)
        // (ƒê·ªïi t√™n t·ª´ 'invite_to_chat' v√† x√≥a confirm())
        globalSocket.on('force_join_room', (data) => {
            console.log('NH·∫¨N ƒê∆Ø·ª¢C L·ªÜNH V√ÄO PH√íNG!', data);
            // T·ª± ƒë·ªông chuy·ªÉn h∆∞·ªõng ngay l·∫≠p t·ª©c
            window.location.href = data.room_url;
        });

        // 4. L·∫ÆNG NGHE C·∫¢NH B√ÅO AI (CHO EXPERT)
        if (USER_ROLE === 'expert') {
            globalSocket.on('new_alert', (data) => {
                console.log('C·∫¢NH B√ÅO AI!!!', data);
                alert(`C·∫¢NH B√ÅO AI KH·∫®N C·∫§P:\n\n${data.message}\n\n(T·ª´ Session ID: ${data.session_id})`);
            });
        }

        // 5. B·∫ÆT S·ª∞ KI·ªÜN B·∫§M N√öT "T√åM NG∆Ø·ªúI TR√í CHUY·ªÜN" (CHO STUDENT)
        const findChatBtn = document.getElementById('find-chat-btn');
        const illnessSelect = document.getElementById('illness-select');

        if (findChatBtn) {
            findChatBtn.addEventListener('click', () => {
                const illnessType = illnessSelect.value;
                if (!illnessType) {
                    alert('Vui l√≤ng ch·ªçn m·ªôt ch·ªß ƒë·ªÅ b·∫°n c·∫ßn gi√∫p ƒë·ª°!');
                    return;
                }

                // 1. V√¥ hi·ªáu h√≥a n√∫t v√† hi·ªÉn th·ªã "ƒêang t√¨m..."
                findChatBtn.disabled = true;
                findChatBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ƒêang t√¨m...';
                illnessSelect.disabled = true;

                // 2. G·ª≠i y√™u c·∫ßu t√¨m chat
                console.log(`ƒêang g·ª≠i y√™u c·∫ßu t√¨m chat, ch·ªß ƒë·ªÅ: ${illnessType}`);
                globalSocket.emit('request_match', { illness: illnessType });
            });
        }

        // 6. L·∫ÆNG NGHE K·∫æT QU·∫¢ T√åM KI·∫æM (CHO STUDENT)
        globalSocket.on('match_failed', (data) => {
            console.log('Match th·∫•t b·∫°i!', data);
            alert("R·∫•t ti·∫øc, hi·ªán t·∫°i kh√¥ng c√≥ ai r·∫£nh. Vui l√≤ng th·ª≠ l·∫°i sau.");
            // B·∫≠t l·∫°i n√∫t
            findChatBtn.disabled = false;
            findChatBtn.innerHTML = '‚ö° T√¨m ng∆∞·ªùi tr√≤ chuy·ªán';
            illnessSelect.disabled = false;
        });

        globalSocket.on('match_found', (data) => {
            console.log('Match th√†nh c√¥ng!', data);
            // T·ª± ƒë·ªông chuy·ªÉn h∆∞·ªõng Student v√†o ph√≤ng
            window.location.href = data.room_url;
        });
    </script>
    {% endif %}

</body>
</html>