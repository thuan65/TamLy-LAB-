<!-- templates/chat_messenger.html -->
<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Chat vá»›i {{ peer_name }}</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { font-family: sans-serif; margin: 20px; background: #f8f9fa; }
h2 { margin-bottom: 20px; }
#chat-box { border: 1px solid #ccc; padding: 15px; height: 400px; overflow-y: auto; background: #fff; border-radius: 5px; }
.message { margin: 5px 0; padding: 8px 12px; border-radius: 15px; max-width: 70%; display: inline-block; }
.message.user { background-color: #d1e7dd; align-self: flex-end; }
.message.peer { background-color: #f8d7da; align-self: flex-start; }
#input-area { margin-top: 10px; display: flex; }
#input-area input { flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
#input-area button { margin-left: 10px; }
#back-btn { margin-bottom: 10px; }
#chat-container { display: flex; flex-direction: column; }
</style>
</head>
<body>

<a id="back-btn" href="{{ role=='student' and '/dashboard_student' or '/dashboard_expert' }}" class="btn btn-secondary">
  â¬… Quay láº¡i Dashboard
</a>

<h2>ðŸ’¬ Chat vá»›i {{ peer_name }}</h2>

<div id="chat-container">
  <div id="chat-box"></div>
  <div id="input-area">
    <input type="text" id="message-input" placeholder="Nháº­p tin nháº¯n...">
    <button class="btn btn-primary" id="send-btn">Gá»­i</button>
  </div>
</div>

<script>
const userId = "{{ user_id }}";
const peerId = "{{ peer_id }}";
const role = "{{ role }}";

const chatBox = document.getElementById("chat-box");
const messageInput = document.getElementById("message-input");
const sendBtn = document.getElementById("send-btn");

// Load tin nháº¯n giá»¯a 2 ngÆ°á»i
async function loadMessages() {
  try {
    const res = await fetch(`/chat/api/get_messages/${userId}/${peerId}`);
    const data = await res.json();
    chatBox.innerHTML = "";
    data.messages.forEach(msg => {
      const div = document.createElement("div");
      div.classList.add("message");
      if(msg.sender_id === userId) {
        div.classList.add("user");
      } else {
        div.classList.add("peer");
      }
      div.textContent = msg.message;
      chatBox.appendChild(div);
    });
    chatBox.scrollTop = chatBox.scrollHeight;
  } catch(err){ console.error(err); }
}

// Gá»­i tin nháº¯n
async function sendMessage() {
  const msg = messageInput.value.trim();
  if(!msg) return;

  try {
    const res = await fetch("/chat/api/send_message", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({sender_id: userId, receiver_id: peerId, message: msg})
    });
    const data = await res.json();
    if(data.status === "success") {
      messageInput.value = "";
      loadMessages();
    } else {
      alert("Gá»­i tháº¥t báº¡i: " + data.message);
    }
  } catch(err){ console.error(err); }
}

// Gá»­i khi nháº¥n nÃºt
sendBtn.addEventListener("click", sendMessage);

// Gá»­i khi nháº¥n Enter
messageInput.addEventListener("keydown", (e) => {
  if(e.key === "Enter") sendMessage();
});

// Tá»± Ä‘á»™ng load tin nháº¯n má»—i 2 giÃ¢y
setInterval(loadMessages, 2000);
window.onload = loadMessages;
</script>

</body>
</html>
