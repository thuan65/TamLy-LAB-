<!-- templates/dashboard.html -->
<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { font-family: sans-serif; margin: 20px; background: #f8f9fa; }
h2 { margin-bottom: 20px; }
.section { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 5px; background: #fff; }
.section h3 { margin-top: 0; }
.button-list button { margin: 5px; padding: 8px 12px; cursor: pointer; }
.button-list { display: flex; flex-wrap: wrap; }
#notifications { color: red; margin-bottom: 10px; }
</style>
</head>
<body>
<h2>ğŸ‘‹ ChÃ o {{ username }}!</h2>
<div id="notifications"></div>

{% if role == "student" %}
<!-- Forum -->
<div class="section" id="forum-section">
  <h3>ğŸ“š Forum</h3>
  <button class="btn btn-success" onclick="window.location='/forum'">VÃ o Forum</button>
</div>

<!-- Chat vá»›i chuyÃªn gia -->
<div class="section" id="expert-chat-section">
  <h3>ğŸ’¬ Chat vá»›i chuyÃªn gia</h3>
  <div class="button-list" id="expert-list"></div>
</div>

{% else %}
<!-- Expert view -->
<!-- Forum -->
<div class="section" id="forum-section">
  <h3>ğŸ“š Forum</h3>
  <button class="btn btn-success" onclick="window.location='/forum'">VÃ o Forum</button>
</div>

<!-- Chat vá»›i há»c sinh -->
<div class="section" id="student-chat-section">
  <h3>ğŸ’¬ Chat vá»›i há»c sinh</h3>
  <div class="button-list" id="student-list"></div>
</div>
{% endif %}

<script>
const role = "{{ role }}";
const userId = "{{ user_id }}";

// Load danh sÃ¡ch chuyÃªn gia cho student
async function loadExperts() {
  if(role !== "student") return;
  try {
    const res = await fetch("/chat/api/get_all_experts");
    const data = await res.json();
    const div = document.getElementById("expert-list");
    div.innerHTML = "";
    data.experts.forEach(e => {
      const btn = document.createElement("button");
      btn.textContent = e.username;
      btn.classList.add("btn","btn-primary","btn-sm");
      btn.onclick = () => window.location = `/chat/${e.id}`;
      div.appendChild(btn);
    });
  } catch(err){ console.error(err); }
}

// Load danh sÃ¡ch há»c sinh Ä‘Ã£ chat cho expert
async function loadStudents() {
  if(role !== "expert") return;
  try {
    const res = await fetch(`/chat/api/get_chats_for_expert/${userId}`);
    const data = await res.json();
    const div = document.getElementById("student-list");
    div.innerHTML = "";
    if(data.students.length === 0) div.textContent = "ChÆ°a cÃ³ há»c sinh nÃ o chat.";
    data.students.forEach(sid => {
      const btn = document.createElement("button");
      btn.textContent = "Há»c sinh " + sid;
      btn.classList.add("btn","btn-primary","btn-sm");
      btn.onclick = () => window.location = `/chat/${sid}`;
      div.appendChild(btn);
    });
  } catch(err){ console.error(err); }
}

// ThÃ´ng bÃ¡o tin nháº¯n má»›i
async function checkUnread() {
  try {
    const res = await fetch(`/chat/api/get_unread/${role}/${userId}`);
    const data = await res.json();
    const notif = document.getElementById("notifications");
    notif.textContent = data.unread>0 ? `Báº¡n cÃ³ ${data.unread} tin nháº¯n má»›i!` : "";
  } catch(err){ console.error(err); }
}

window.onload = () => {
  loadExperts();
  loadStudents();
  checkUnread();
  setInterval(checkUnread, 5000);
  setInterval(loadExperts, 5000);
  setInterval(loadStudents, 5000);
}
</script>
</body>
</html>
