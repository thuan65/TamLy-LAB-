<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8">
    <title>Đánh giá Sức khỏe Tinh thần</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <link href="{{ url_for('static', filename='img/favicon.ico') }}" rel="icon">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <link href="{{ url_for('static', filename='lib/animate/animate.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='lib/owlcarousel/assets/owl.carousel.min.css') }}" rel="stylesheet">

    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">

    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: #f8f9fa;
        }
        h1, h2, h3, h4, h5, .section-title {
            font-family: 'Be Vietnam Pro', sans-serif;
            font-weight: 700;
        }
        .quiz-bg {
            background: #f4f7f8;
            min-height: 100vh;
            padding: 40px 0;
        }
        .quiz-card {
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
            background: #ffffff;
            border: 1px solid #e1e8ed; 
        }
        .quiz-progress {
            height: 8px;
            border-radius: 10px;
            background: #e9ecef;
        }
        .option-pill {
            border-radius: 50px;
            padding: 10px 20px;
            transition: all 0.3s;
            border: 2px solid #002147;
            color: #002147;
        }
        .btn-check:checked + .option-pill {
            background-color: #ffc107 !important;
            color: #000 !important;
        }
        #submitBtn {
            background-color: #1ea3b2; 
            border: none;
            font-weight: 600;
            letter-spacing: 1px;
        }
        #submitBtn:hover {
            background-color: #168d9a;
        }
        .result-score {
            font-size: 56px;
            color: #002147;
        }
        .text-orange { color: #fd7e14 !important; }
        .border-orange { border-color: #fd7e14 !important; }
        .history-lookup-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>

    <div id="spinner" class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
        <div class="spinner-border text-primary"></div>
    </div>

    <div class="container-fluid py-5 quiz-bg wow fadeIn" data-wow-delay="0.1s">
        <div class="container mb-3">
            <a href="{{ url_for('home') }}" class="btn btn-outline-primary rounded-pill px-4">
                <i class="fa-solid fa-house me-2"></i>Home
            </a>
        </div>

        <div class="container">
            <div class="text-center mx-auto mb-5 wow fadeIn quiz-heading" data-wow-delay="0.1s" style="max-width: 750px;">
                <p class="section-title bg-white text-center text-primary px-3">Mental Health</p>
                <h1 class="display-6 mb-3">Khảo sát sức khỏe tinh thần</h1>
                <p>
                    Trong <strong>2 tuần vừa qua</strong>, bạn gặp các vấn đề sau với tần suất như thế nào?<br>
                    Hãy trả lời trung thực để có kết quả phù hợp (chỉ mang tính tham khảo).
                </p>
            </div>

            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="bg-light p-4 p-md-5 quiz-card wow fadeInUp" data-wow-delay="0.1s">

                        <!-- Phần xem lại lịch sử -->
                        <div class="history-lookup-section" id="historyLookupSection">
                            <h5 class="mb-3 text-center">
                                <i class="fa-solid fa-clock-rotate-left me-2"></i>Xem lại lịch sử đánh giá của bạn
                            </h5>
                            <div class="row g-3">
                                <div class="col-12">
                                    <button class="btn btn-outline-primary w-100 py-3" onclick="lookupCurrentUserHistory()" id="btnLookupHistory">
                                        <i class="fa-solid fa-search me-2"></i> Xem lịch sử đánh giá
                                    </button>
                                </div>
                            </div>

                            <div id="inline-history" class="mt-4" style="display:none;"></div>
                        </div>

                        <hr class="my-4">

                        <div class="mb-4">
                            <div class="d-flex justify-content-between mb-2">
                                <small class="text-muted">Tiến độ khảo sát</small>
                                <small class="text-muted"><span id="answeredCount">0</span>/<span id="totalCount">0</span></small>
                            </div>
                            <div class="quiz-progress">
                                <div class="progress-bar bg-primary" id="progressBar" style="width:0%"></div>
                            </div>
                        </div>

                        <form id="quizForm">
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="ho_ten" placeholder="Họ tên" required>
                                        <label for="ho_ten">Họ và tên *</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="username" placeholder="MSSV/Username" required>
                                        <label for="username">Tên đăng nhập *</label>
                                    </div>
                                </div>
                            </div>

                            <hr class="my-4">

                            <div id="questions-container"></div>

                            <div class="mt-5">
                                <button type="button" class="btn btn-primary w-100 py-3" onclick="submitQuiz()" id="submitBtn" disabled>
                                    <i class="fa-regular fa-paper-plane me-2"></i>Nộp bài khảo sát
                                </button>
                                <div class="alert alert-warning text-center mt-3 mb-0">
                                    <i class="fa-solid fa-triangle-exclamation me-2"></i>
                                    Lưu ý: Bài khảo sát chỉ mang tính tham khảo, không thay thế chẩn đoán từ chuyên gia y tế.
                                </div>
                            </div>
                        </form>

                        <div id="result" class="mt-4" style="display:none;"></div>

                        <div id="afterQuizActions" style="display:none;">
                            <div class="text-center mt-4">
                                <a href="{{ url_for('booking.select_therapist') }}" class="btn btn-primary py-2 px-4">
                                    <i class="fa-solid fa-user-doctor me-2"></i>Xem danh sách chuyên gia tư vấn
                                </a>
                            </div>
                            <div class="text-center mt-3">
                                <button class="btn btn-outline-primary rounded-pill px-4" onclick="loadHistoryAfterQuiz()">
                                    <i class="fa-solid fa-clock-rotate-left me-2"></i>Xem lịch sử khảo sát
                                </button>
                            </div>
                        </div>

                        <div id="history" class="mt-5" style="display:none;">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h4 class="mb-0">Lịch sử khảo sát</h4>
                                <button class="btn btn-sm btn-outline-secondary" onclick="hideHistory()">
                                    <i class="fa-solid fa-times"></i> Đóng
                                </button>
                            </div>
                            <div id="history-list" class="row g-4"></div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer Start -->
    <div class="container-fluid footer py-5 wow fadeIn" data-wow-delay="0.1s">
        <div class="container">
            <div class="row g-5">
                <div class="col-lg-4 col-md-6">
                    <h4 class="text-light mb-4">Our Office</h4>
                    <p class="mb-2"><i class="fa fa-map-marker-alt me-3"></i>227 Nguyễn Văn Cừ, <br> P. Chợ Quán, TPHCM</p>
                    <p class="mb-2"><i class="fa fa-phone-alt me-3"></i>+012 345 67890</p>
                    <p class="mb-2"><i class="fa fa-envelope me-3"></i>info@example.com</p>
                    <div class="d-flex pt-3">
                         <a class="btn btn-square btn-primary me-2" href="#"><i class="fab fa-x-twitter"></i></a>
                         <a class="btn btn-square btn-primary me-2" href="#"><i class="fab fa-facebook-f"></i></a>
                         <a class="btn btn-square btn-primary me-2" href="#"><i class="fab fa-youtube"></i></a>
                         <a class="btn btn-square btn-primary me-2" href="#"><i class="fab fa-linkedin-in"></i></a>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6">
                    <h4 class="text-light mb-4">About Us</h4>
                    <p>24127552 - Nguyễn Võ Nhật Thuận</p>
                    <p>24127386 - Vũ Đỗ Mạnh Hùng</p>
                    <p>24127248 - Nguyễn Trần Phương Thúy</p>
                    <p>24127086 - Trần Hoàng Khánh My</p>
                    <p>24127302 - Nguyễn Xuân Quyền</p>
                    <p>24127106 - Lai Phạm Như Phúc</p>
                    <p>24127207 - Nguyễn Thục Nghi</p>
                </div> 
                <div class="col-lg-4 col-md-6">   
                    <h6 class="text-light">Course Information</h6>
                    <p class="mb-1">Course Name: Computational Thinking</p>
                    <h6 class="text-light">Course ID: CSC10014</h6>
                    <h6 class="text-light">Lecturer:</h6>
                    <p class="mb-1">Dr. Le Ngoc Thanh</p>
                    <p class="mb-1">Mr. Huynh Lam Hai Dang</p>
                    <p class="mb-1">Mr. Nguyen Thanh Tinh</p>
                </div>
            </div>
            <div class="copyright pt-5">
                <div class="row">
                    <div class="col-md-6 text-center text-md-start mb-3 mb-md-0">
                        &copy; <a class="fw-semi-bold" href="#">Thất đại tội</a>, All Right Reserved.
                    </div>
                    <div class="col-md-6 text-center text-md-end">
                        Designed By <a class="fw-semi-bold" href="https://htmlcodex.com">HTML Codex</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="bi bi-arrow-up"></i></a>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='lib/wow/wow.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>

    <script>
        let totalQuestions = 0;
        let currentUsername = null;

        async function loadQuestions() {
            try {
                const res = await fetch('/quiz/lay-cau-hoi');
                const data = await res.json();
                
                const ctn = document.getElementById('questions-container');
                ctn.innerHTML = '';
                
                totalQuestions = data.cau_hoi.length + 1;
                document.getElementById('totalCount').textContent = totalQuestions;

                data.cau_hoi.forEach((q, i) => {
                    ctn.innerHTML += `
                        <div class="p-4 bg-white rounded mb-3 shadow-sm">
                            <h5 class="mb-3">${i+1}. ${q}</h5>
                            <div class="option-grid">
                                ${data.tan_suat.map((label, value) => `
                                    <input type="radio" class="btn-check" name="q${i}" id="q${i}_${value}" value="${value}" onchange="updateProgress()">
                                    <label class="btn btn-outline-primary option-pill" for="q${i}_${value}">${label}</label>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });

                ctn.innerHTML += `
                    <div class="p-4 bg-white rounded mb-3 shadow-sm">
                        <h5 class="mb-3">${totalQuestions}. Những vấn đề trên gây khó khăn thế nào cho cuộc sống của bạn?</h5>
                        <div class="option-grid">
                            ${data.anh_huong.map((label, value) => `
                                <input type="radio" class="btn-check" name="impact" id="impact_${value}" value="${value}" onchange="updateProgress()">
                                <label class="btn btn-outline-primary option-pill" for="impact_${value}">${label}</label>
                            `).join('')}
                        </div>
                    </div>
                `;
            } catch (e) { 
                console.error("Lỗi tải câu hỏi:", e); 
            }
        }

        function updateProgress() {
            const answered = document.querySelectorAll('input[type=radio]:checked').length;
            document.getElementById('answeredCount').textContent = answered;
            const percent = (answered / totalQuestions) * 100;
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('submitBtn').disabled = (answered !== totalQuestions);
        }

        async function submitQuiz() {
            const hoTen = document.getElementById('ho_ten').value.trim();
            const user = document.getElementById('username').value.trim();
            
            if (!hoTen || !user) {
                alert('Vui lòng nhập đầy đủ Họ tên và Tên đăng nhập (hoặc MSSV)!');
                return;
            }

            let answers = [];
            for (let i = 0; i < totalQuestions - 1; i++) {
                const choice = document.querySelector(`input[name="q${i}"]:checked`);
                if (!choice) {
                    alert(`Bạn chưa hoàn thành câu hỏi số ${i + 1}`);
                    return;
                }
                answers.push(Number(choice.value));
            }

            const impactRadio = document.querySelector('input[name="impact"]:checked');
            if (!impactRadio) {
                alert('Vui lòng trả lời câu hỏi về mức độ ảnh hưởng cuộc sống!');
                return;
            }
            const impactValue = Number(impactRadio.value);

            const btn = document.getElementById('submitBtn');
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Đang xử lý dữ liệu...';

            try {
                const res = await fetch('/quiz/nop-bai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ho_ten: hoTen,      
                        username: user,     
                        tra_loi: answers,   
                        anh_huong: impactValue 
                    })
                });

                const data = await res.json();

                if (data.success) {
                    currentUsername = user;
                    showResult(data);
                    document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert('Lỗi: ' + (data.message || 'Không thể lưu kết quả'));
                    btn.disabled = false;
                    btn.innerHTML = originalContent;
                }
            } catch (e) {
                console.error("Lỗi nộp bài:", e);
                alert("Lỗi kết nối đến máy chủ. Vui lòng kiểm tra lại mạng!");
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }

        // Hàm tra cứu lịch sử từ username trong form
        async function lookupCurrentUserHistory() {
            const username = document.getElementById('username').value.trim();
            
            if (!username) {
                alert('Vui lòng nhập tên đăng nhập trước khi xem lịch sử!');
                document.getElementById('username').focus();
                return;
            }

            const btn = document.getElementById('btnLookupHistory');
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Đang tải...';

            try {
                const res = await fetch(`/quiz/lich-su?username=${encodeURIComponent(username)}`);
                const data = await res.json();

                if (data.success) {
                    if (data.lich_su.length === 0) {
                        displayInlineHistory({ 
                            lich_su: [], 
                            user_name: username,
                            full_name: data.full_name || username
                        });
                    } else {
                        displayInlineHistory(data);
                    }
                } else {
                    alert(data.message || 'Không tìm thấy lịch sử khảo sát');
                }
            } catch (e) {
                console.error("Lỗi tra cứu lịch sử:", e);
                alert('Lỗi kết nối server. Vui lòng thử lại!');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }

        function showResult(data) {
            document.getElementById('quizForm').style.display = 'none';
            document.querySelector('.quiz-heading').style.display = 'none';
            document.getElementById('historyLookupSection').style.display = 'none';

            const resDiv = document.getElementById('result');
            resDiv.style.display = 'block';
            document.getElementById('afterQuizActions').style.display = 'block';

            let colorClass = "";
            if (data.diem <= 9) colorClass = "text-success";
            else if (data.diem <= 14) colorClass = "text-warning";
            else if (data.diem <= 19) colorClass = "text-orange";
            else colorClass = "text-danger";
            
            resDiv.innerHTML = `
                <div class="text-center p-4 bg-white rounded border">
                    <h3 class="mb-3">Kết quả khảo sát</h3>
                    <div class="result-score ${colorClass}">${data.diem}/27</div>
                    <h4 class="mt-2">Mức độ: <span class="${colorClass}">${data.muc_do}</span></h4>
                    <p class="text-muted">Ảnh hưởng: ${data.anh_huong_text}</p>
                    ${data.canh_bao ? `<div class="alert alert-danger"><strong>CẢNH BÁO:</strong> ${data.canh_bao}</div>` : ''}
                    <div class="row g-3 text-start mt-3">
                        <div class="col-md-6"><div class="p-3 bg-light rounded"><h6>Lời khuyên:</h6><small>${data.loi_khuyen.join('<br>')}</small></div></div>
                        <div class="col-md-6"><div class="p-3 bg-light rounded"><h6>Hành động:</h6><small>${data.hanh_dong.join('<br>')}</small></div></div>
                    </div>
                </div>
            `;
        }

        // Load lịch sử sau khi làm quiz
        async function loadHistoryAfterQuiz() {
            if (!currentUsername) {
                alert('Không tìm thấy thông tin người dùng');
                return;
            }

            try {
                const res = await fetch(`/quiz/lich-su?username=${encodeURIComponent(currentUsername)}`);
                const data = await res.json();

                if (data.success) {
                    displayHistory(data);
                } else {
                    alert(data.message || 'Không thể tải lịch sử');
                }
            } catch (e) {
                console.error("Lỗi tải lịch sử:", e);
                alert('Lỗi kết nối. Vui lòng thử lại!');
            }
        }

        function displayHistory(data) {
            const historyDiv = document.getElementById('history');
            historyDiv.style.display = 'block';
            
            let html = `
                <div class="alert alert-info mb-4">
                    <strong>Tên đăng nhập:</strong> ${data.user_name}<br>
                    <strong>Họ tên:</strong> ${data.full_name || 'N/A'}
                </div>
                <div class="row g-4">
            `;
            
            data.lich_su.forEach((log, index) => {
                let statusColor = "";
                let borderStyle = "";
                
                if (log.diem <= 9) {
                    statusColor = "text-success"; 
                    borderStyle = "border-success";
                } else if (log.diem <= 14) {
                    statusColor = "text-warning"; 
                    borderStyle = "border-warning";
                } else if (log.diem <= 19) {
                    statusColor = "text-orange"; 
                    borderStyle = "border-orange";
                } else {
                    statusColor = "text-danger";  
                    borderStyle = "border-danger";
                }

                html += `
                    <div class="col-md-6">
                        <div class="card history-card h-100 border-2 ${borderStyle}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="badge bg-secondary">#${data.lich_su.length - index}</span>
                                    <span class="fs-4">${log.icon || ''}</span>
                                </div>
                                <h5 class="${statusColor}">${log.diem}/27 điểm</h5>
                                <p class="mb-1"><strong>Mức độ:</strong> ${log.muc_do}</p>
                                <p class="small text-muted mb-0"><i class="bi bi-calendar-event me-1"></i>${log.thoi_gian}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById('history-list').innerHTML = html;
            historyDiv.style.display = 'block';
            historyDiv.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }

        function displayInlineHistory(data) {
            const container = document.getElementById('inline-history');
            container.style.display = 'block';

            if (!data.lich_su || data.lich_su.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning text-center">
                        <i class="fa-solid fa-info-circle me-2"></i>
                        Bạn chưa có lịch sử khảo sát.
                    </div>
                `;
                return;
            }

            let html = `
                <div class="alert alert-info py-2 mb-3">
                    <small>Lịch sử của: <strong>${data.full_name || data.user_name}</strong></small>
                </div>
                <div class="row g-2" style="max-height: 400px; overflow-y: auto;">
            `;

            data.lich_su.forEach((log, index) => {
                let color = "border-secondary";
                if (log.diem <= 9) color = "border-success";
                else if (log.diem <= 14) color = "border-warning";
                else if (log.diem <= 19) color = "border-orange";
                else color = "border-danger";

                html += `
                    <div class="col-12">
                        <div class="card border-2 ${color} mb-2 shadow-sm">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">${log.diem}/27 điểm - ${log.muc_do}</h6>
                                        <small class="text-muted">${log.thoi_gian}</small>
                                    </div>
                                    <span class="fs-4">${log.icon || ''}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function hideHistory() {
            document.getElementById('history').style.display = 'none';
        }

        window.onload = loadQuestions;
    </script>
</body>
</html>
